<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ê°„ ì—…ë¬´ë³´ê³  (Firestore í˜‘ì—…)</title>
    <!-- Tailwind CSS CDN ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter í°íŠ¸ ì‚¬ìš© ì„¤ì • -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        /* ë‚´ìš© í¸ì§‘ í•„ë“œì˜ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        .editable-content {
            min-height: 24px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.15s ease-in-out;
            cursor: text;
        }
        .editable-content:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(66, 153, 225, 0.5); /* blue-500 shadow */
            background-color: #fff;
        }
        .editable-container {
            border: 1px solid #e5e7eb; /* gray-200 */
            border-radius: 8px;
            padding: 1rem;
            min-height: 200px;
        }
        /* ì¶”ê°€/ì‚­ì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .action-button {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.2s, opacity 0.2s;
        }
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .spinner {
            border-top-color: #3b82f6;
            border-left-color: #3b82f6;
            border-bottom-color: transparent;
            border-right-color: transparent;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ì¸ì‡„ ì‹œ ì œì™¸í•  ìš”ì†Œ ìˆ¨ê¸°ê¸° */
        @media print {
            #save-button, #print-button, #user-id-display, #save-status, .delete-item-btn, #add-bank-item-container, .editable-content:focus {
                display: none !important;
            }
            body, .max-w-7xl {
                background: none !important;
                box-shadow: none !important;
            }
            .editable-content {
                cursor: default;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- ë¡œë”© ì¸ë””ì¼€ì´í„° ë° ë©”ì‹œì§€ ë°•ìŠ¤ -->
    <div id="status-message" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 hidden flex items-center justify-center">
        <div id="message-box" class="bg-white p-6 rounded-lg shadow-2xl text-center">
            <div id="loading-spinner" class="spinner w-8 h-8 border-4 rounded-full mx-auto mb-3"></div>
            <p id="message-text" class="text-gray-700 font-semibold">ë°ì´í„° ë¡œë”© ì¤‘...</p>
        </div>
    </div>

    <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
    <div class="max-w-7xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-lg">

        <!-- í—¤ë” ë° ë³´ê³ ì¼ì -->
        <header class="mb-8 border-b-2 border-indigo-600 pb-4">
            <!-- ì œëª©: ì¬ë¬´ë³¸ë¶€ë¡œ ìˆ˜ì • -->
            <h1 class="text-3xl font-bold text-gray-800 text-center mb-1">ì¬ë¬´ë³¸ë¶€ ì£¼ê°„ ì—…ë¬´ë³´ê³ </h1>
            <div class="text-center text-sm text-gray-500">
                <span id="user-id-display" class="font-mono text-xs bg-gray-100 px-2 py-1 rounded">ì‚¬ìš©ì ID: ë¡œë”© ì¤‘...</span>
                <p id="report-date-display" class="text-lg font-medium text-indigo-600 mt-2">ë³´ê³ ì¼ì: 2024ë…„ 00ì›” 00ì¼ (í™”)</p>
                <!-- ì €ì¥ ë²„íŠ¼ ë° ìƒíƒœ í‘œì‹œ ì¶”ê°€ -->
                <button id="save-button" class="mt-3 px-4 py-1 bg-green-500 text-white rounded-lg shadow-md hover:bg-green-600 transition duration-150 ease-in-out">
                    <span id="save-icon">ğŸ’¾</span> ì €ì¥
                </button>
                <!-- ì¸ì‡„ ë²„íŠ¼ ì¶”ê°€ -->
                <button id="print-button" class="mt-3 ml-2 px-4 py-1 bg-gray-500 text-white rounded-lg shadow-md hover:bg-gray-600 transition duration-150 ease-in-out">
                    <span id="print-icon">ğŸ–¨ï¸</span> ì¸ì‡„
                </button>
                <p id="save-status" class="text-xs text-gray-400 mt-1 h-3 transition duration-500 opacity-0">ì €ì¥ ìƒíƒœ</p>
            </div>
        </header>

        <!-- ë©”ì¸ ë³´ê³ ì„œ ê·¸ë¦¬ë“œ -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

            <!-- ì¢Œì¸¡: ì „ì£¼ì‚¬í•­ -->
            <section class="p-4 bg-gray-50 rounded-lg shadow-inner">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-gray-700">
                    ì „ì£¼ì‚¬í•­ <span id="prev-period-display" class="text-base font-normal text-gray-500">(00/00 ~ 00/00)</span>
                </h2>

                <!-- ì¹´í…Œê³ ë¦¬: ìê¸ˆ - ì „ì£¼ì‚¬í•­ -->
                <div class="mb-6">
                    <h3 class="text-lg font-bold text-indigo-700 mb-2 p-1 border-l-4 border-indigo-500 pl-2">ğŸ’° ìê¸ˆ</h3>
                    <div class="space-y-4">
                        <!-- ìê¸ˆ í˜„í™© í‘œ (ì „ì£¼ì‚¬í•­ì—ë§Œ ì¡´ì¬) -->
                        <div class="p-3 bg-white rounded-lg border">
                            <h4 class="font-medium mb-2 text-sm text-gray-600">ìê¸ˆ í˜„í™© (ì”ì•¡ ê¸°ì¤€)</h4>
                            <div id="fund-balance-table">
                                <!-- JSê°€ í…Œì´ë¸” ë‚´ìš©ì„ ì±„ì›ë‹ˆë‹¤ -->
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="bg-gray-100">
                                            <th class="p-2 text-left w-1/4">êµ¬ë¶„</th> <!-- êµ¬ë¶„ í•­ëª© í¸ì§‘ ê°€ëŠ¥í•˜ê²Œ í™•ì¥ -->
                                            <th class="p-2 text-right">ë‹¹ì¢Œ</th>
                                            <th class="p-2 text-right">ë³´í†µ</th>
                                            <th class="p-2 text-right">í•©ê³„</th>
                                            <!-- [ìˆ˜ì •] ì•¡ì…˜ í—¤ë” ì œê±° -->
                                            <th class="p-2 text-center w-16"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="bank-rows">
                                        <!-- ì€í–‰ë³„ ë°ì´í„° í–‰ì´ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤. -->
                                    </tbody>
                                </table>
                                <!-- í•­ëª© ì¶”ê°€ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ -->
                                <div id="add-bank-item-container" class="mt-4"></div>
                            </div>
                        </div>
                        <!-- ì£¼ìš” ì—…ë¬´ ë¦¬ìŠ¤íŠ¸ -->
                        <div class="editable-container" id="fund-prev-list">
                            <!-- JSê°€ ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œì„ ì±„ì›ë‹ˆë‹¤ -->
                        </div>
                    </div>
                </div>

                <!-- ì¹´í…Œê³ ë¦¬: íšŒê³„/ì„¸ë¬´ - ì „ì£¼ì‚¬í•­ -->
                <div>
                    <h3 class="text-lg font-bold text-green-700 mb-2 p-1 border-l-4 border-green-500 pl-2">ğŸ§¾ íšŒê³„/ì„¸ë¬´</h3>
                    <div class="editable-container" id="tax-prev-list">
                        <!-- JSê°€ ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œì„ ì±„ì›ë‹ˆë‹¤ -->
                    </div>
                </div>
            </section>

            <!-- ìš°ì¸¡: ê¸ˆì£¼ì‚¬í•­ -->
            <section class="p-4 bg-white rounded-lg shadow-inner">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-gray-700">
                    ê¸ˆì£¼ì‚¬í•­ <span id="curr-period-display" class="text-base font-normal text-gray-500">(00/00 ~ 00/00)</span>
                </h2>

                <!-- ì¹´í…Œê³ ë¦¬: ìê¸ˆ - ê¸ˆì£¼ì‚¬í•­ -->
                <div class="mb-6">
                    <h3 class="text-lg font-bold text-indigo-700 mb-2 p-1 border-l-4 border-indigo-500 pl-2">ğŸ’° ìê¸ˆ</h3>
                    <div class="editable-container" id="fund-curr-list">
                        <!-- JSê°€ ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œì„ ì±„ì›ë‹ˆë‹¤ -->
                    </div>
                </div>

                <!-- ì¹´í…Œê³ ë¦¬: íšŒê³„/ì„¸ë¬´ - ê¸ˆì£¼ì‚¬í•­ -->
                <div>
                    <h3 class="text-lg font-bold text-green-700 mb-2 p-1 border-l-4 border-green-500 pl-2">ğŸ§¾ íšŒê³„/ì„¸ë¬´</h3>
                    <div class="editable-container" id="tax-curr-list">
                        <!-- JSê°€ ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œì„ ì±„ì›ë‹ˆë‹¤ -->
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Firebase SDK (ES Module) -->
    <script type="module">
        // Firebase ëª¨ë“ˆ ì„í¬íŠ¸
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, getDoc, runTransaction, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firestore ë””ë²„ê·¸ ë¡œê¹… í™œì„±í™”
        setLogLevel('Debug');

        // --- 1. ì „ì—­ ë³€ìˆ˜ ì„¤ì • ë° Firebase ì´ˆê¸°í™” ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = 'loading';
        let reportRef;
        let unsubscribe = null;
        let isAuthReady = false;
        let isSaving = false; // ì €ì¥ ìƒíƒœ í”Œë˜ê·¸

        // ìê¸ˆ í˜„í™© ë°ì´í„°ì˜ ìƒˆë¡œìš´ ì´ˆê¸° êµ¬ì¡° (ë°°ì—´ ê¸°ë°˜)
        const INITIAL_BANK_DATA_ARRAY = [
            { name: "ì‹ í•œì€í–‰", ë‹¹ì¢Œ: "0ì–µ", ë³´í†µ: "0ì–µ", í•©ê³„: "0ì–µ", isEditable: true },
            { name: "í•˜ë‚˜ì€í–‰", ë‹¹ì¢Œ: "0ì–µ", ë³´í†µ: "0ì–µ", í•©ê³„: "0ì–µ", isEditable: true },
            { name: "ì‚°ì—…ì€í–‰", ë‹¹ì¢Œ: "0ì–µ", ë³´í†µ: "0ì–µ", í•©ê³„: "0ì–µ", isEditable: true },
            { name: "í•©ê³„", ë‹¹ì¢Œ: "0ì–µ", ë³´í†µ: "0ì–µ", í•©ê³„: "0ì–µ", isEditable: false }, // ê³ ì •ëœ í•©ê³„ í–‰
        ];
        const UNIT = 'ì–µ';

        // UI ìš”ì†Œ
        const reportDateDisplay = document.getElementById('report-date-display');
        const prevPeriodDisplay = document.getElementById('prev-period-display');
        const currPeriodDisplay = document.getElementById('curr-period-display');
        const userIdDisplay = document.getElementById('user-id-display');
        const fundPrevList = document.getElementById('fund-prev-list');
        const fundCurrList = document.getElementById('fund-curr-list');
        const taxPrevList = document.getElementById('tax-prev-list');
        const taxCurrList = document.getElementById('tax-curr-list');
        const bankRowsContainer = document.getElementById('bank-rows');
        const statusMessage = document.getElementById('status-message');
        const messageText = document.getElementById('message-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const saveButton = document.getElementById('save-button');
        const printButton = document.getElementById('print-button'); // ì¸ì‡„ ë²„íŠ¼
        const saveStatus = document.getElementById('save-status');
        const fundBalanceTableContainer = document.getElementById('fund-balance-table');

        // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        const showMessage = (text, isLoading = false) => {
            messageText.textContent = text;
            if (isLoading) {
                loadingSpinner.classList.remove('hidden');
            } else {
                loadingSpinner.classList.add('hidden');
            }
            statusMessage.classList.remove('hidden');
        };

        const hideMessage = () => {
            statusMessage.classList.add('hidden');
        };

        // ì €ì¥ ìƒíƒœ í‘œì‹œ í•¨ìˆ˜
        const setSaveStatus = (message, color = 'text-gray-400') => {
            saveStatus.textContent = message;
            saveStatus.className = `text-xs mt-1 h-3 transition duration-500 ${color} opacity-100`;
            clearTimeout(saveStatus.timer);
            saveStatus.timer = setTimeout(() => {
                saveStatus.classList.remove('opacity-100');
                saveStatus.classList.add('opacity-0');
            }, 3000);
        };

        // --- 2. ë‚ ì§œ ê³„ì‚° ë¡œì§ ---
        function getReportDates() {
            const today = new Date();
            const dayOfWeek = today.getDay(); 
            let diff = 2 - dayOfWeek;
            if (dayOfWeek > 2) { 
                diff -= 7;
            } else if (dayOfWeek === 2 && today.getHours() >= 0) {
            } else if (dayOfWeek === 1 || dayOfWeek === 0) { 
                diff = 2 - dayOfWeek - 7;
            }

            const reportDate = new Date(today);
            reportDate.setDate(today.getDate() + diff);

            const reportDateString = reportDate.toISOString().slice(0, 10);
            const reportDateFormatted = `${reportDate.getFullYear()}ë…„ ${reportDate.getMonth() + 1}ì›” ${reportDate.getDate()}ì¼ (í™”)`;

            const getMondayOfWeek = (date) => {
                const day = date.getDay() === 0 ? 7 : date.getDay(); 
                const monday = new Date(date);
                monday.setDate(date.getDate() - day + 1);
                return monday;
            };

            const currMonday = getMondayOfWeek(reportDate);
            const prevMonday = new Date(currMonday);
            prevMonday.setDate(currMonday.getDate() - 7);

            const formatDate = (date) => `${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;
            const getPeriodString = (monday) => {
                const friday = new Date(monday);
                friday.setDate(monday.getDate() + 4);
                return `(${formatDate(monday)} ~ ${formatDate(friday)})`;
            };

            const prevPeriod = getPeriodString(prevMonday);
            const currPeriod = getPeriodString(currMonday);

            return { reportDateString, reportDateFormatted, prevPeriod, currPeriod };
        }

        // --- 3. Firebase ë° Firestore ì´ˆê¸°í™” ---
        if (firebaseConfig) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // ì¸ì¦ ìƒíƒœ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        if (initialAuthToken) {
                            try {
                                await signInWithCustomToken(auth, initialAuthToken);
                                userId = auth.currentUser.uid;
                            } catch (error) {
                                console.error("Custom token sign in failed. Falling back to anonymous.", error);
                                await signInAnonymously(auth);
                                userId = auth.currentUser.uid;
                            }
                        } else {
                            await signInAnonymously(auth);
                            userId = auth.currentUser.uid;
                        }
                    }

                    userIdDisplay.textContent = `ì‚¬ìš©ì ID: ${userId}`;
                    isAuthReady = true;
                    if (db) {
                        loadAndListenToReport();
                    } else {
                        console.error("Firestore DB not initialized.");
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showMessage(`Firebase ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}. (config í™•ì¸ í•„ìš”)`);
            }
        } else {
            showMessage("Firebase ì„¤ì • ì •ë³´(__firebase_config)ê°€ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.", false);
        }

        // --- 4. Firestore ì—°ë™ í•¨ìˆ˜ ---

        // Firestore ë¬¸ì„œ ì°¸ì¡° ê°€ì ¸ì˜¤ê¸° (ê³µìœ  ë°ì´í„° ê²½ë¡œ)
        function getReportDocumentRef() {
            if (!isAuthReady) {
                console.error("Auth is not ready yet.");
                return null;
            }
            const { reportDateString } = getReportDates();
            const collectionPath = `/artifacts/${appId}/public/data/weeklyReports`;
            return doc(db, collectionPath, reportDateString);
        }

        // ì‹¤ì‹œê°„ ë°ì´í„° ë¡œë“œ ë° ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function loadAndListenToReport() {
            if (unsubscribe) {
                unsubscribe(); // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ í•´ì œ
            }

            reportRef = getReportDocumentRef();
            if (!reportRef) return;

            const { reportDateString, reportDateFormatted, prevPeriod, currPeriod } = getReportDates();
            showMessage("ì‹¤ì‹œê°„ ë°ì´í„° ì—°ê²° ì¤‘...", true);

            unsubscribe = onSnapshot(reportRef, async (docSnapshot) => {
                hideMessage();
                if (docSnapshot.exists()) {
                    console.log("Document data received:", docSnapshot.data());
                    renderReport(docSnapshot.data());
                } else {
                    console.log("No such document. Creating new report.");
                    showMessage("ìƒˆ ë³´ê³ ì„œ ë¬¸ì„œ ìƒì„± ì¤‘...", true);

                    const initialData = {
                        dateReported: reportDateFormatted,
                        datePeriodPrev: prevPeriod,
                        datePeriodCurr: currPeriod,
                        contentFundPrev: { bankData: INITIAL_BANK_DATA_ARRAY, list: ["ì „ì£¼ ì£¼ìš” ì—…ë¬´ 1", "ì „ì£¼ ì£¼ìš” ì—…ë¬´ 2"] },
                        contentFundCurr: { list: ["ê¸ˆì£¼ ì£¼ìš” ì—…ë¬´ 1", "ê¸ˆì£¼ ì£¼ìš” ì—…ë¬´ 2"] },
                        contentTaxPrev: { list: ["ì „ì£¼ íšŒê³„/ì„¸ë¬´ ì—…ë¬´ 1", "ì „ì£¼ íšŒê³„/ì„¸ë¬´ ì—…ë¬´ 2"] },
                        contentTaxCurr: { list: ["ê¸ˆì£¼ íšŒê³„/ì„¸ë¬´ ì—…ë¬´ 1", "ê¸ˆì£¼ íšŒê³„/ì„¸ë¬´ ì—…ë¬´ 2"] },
                    };
                    
                    try {
                        await setDoc(reportRef, initialData);
                        renderReport(initialData);
                        hideMessage();
                    } catch (e) {
                        console.error("Error creating document: ", e);
                        showMessage(`ë³´ê³ ì„œ ìƒì„± ì‹¤íŒ¨: ${e.message}`, false);
                    }
                }
            }, (error) => {
                console.error("Error listening to document:", error);
                showMessage(`ë°ì´í„° ì—°ê²° ì˜¤ë¥˜: ${error.message}`, false);
            });
        }
        
        /**
         * Firestoreì˜ íŠ¹ì • í•„ë“œ ê°’ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜ (ì£¼ìš” ì—…ë¬´ ë¦¬ìŠ¤íŠ¸ìš©).
         */
        async function updateField(fieldName, value) {
            if (!isAuthReady || !reportRef || isSaving) {
                console.warn("Firestoreê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì €ì¥ ì¤‘ì…ë‹ˆë‹¤. ì €ì¥ ê±´ë„ˆë›°ê¸°.");
                return;
            }
            
            isSaving = true;
            setSaveStatus("ì €ì¥ ì¤‘...", 'text-yellow-600');
            
            try {
                await updateDoc(reportRef, { [fieldName]: value });
                console.log(`Field ${fieldName} updated successfully.`);
                setSaveStatus("ì €ì¥ ì™„ë£Œ!", 'text-green-600');
            } catch (error) {
                console.error(`Error updating field ${fieldName}:`, error);
                setSaveStatus(`ì €ì¥ ì‹¤íŒ¨: ${error.message}`, 'text-red-600');
            } finally {
                isSaving = false;
            }
        }

        // --- 5. ìê¸ˆ í˜„í™© í…Œì´ë¸” ê´€ë¦¬ (Transaction ê¸°ë°˜ìœ¼ë¡œ ìˆ˜ì •) ---

        /**
         * ì€í–‰ ì”ì•¡ ë°°ì—´ì„ ë°›ì•„ í•©ê³„ í•„ë“œë¥¼ ê³„ì‚°í•˜ì—¬ ì—…ë°ì´íŠ¸ëœ ë°°ì—´ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
         * @param {Array<object>} dataArray - í˜„ì¬ ì€í–‰ ë°ì´í„° ë°°ì—´
         * @returns {Array<object>} í•©ê³„ê°€ ê³„ì‚°ëœ ìƒˆ ë°°ì—´
         */
        function recalculateTotals(dataArray) {
            let totalDangjwa = 0;
            let totalBotong = 0;
            const newData = JSON.parse(JSON.stringify(dataArray));
            
            // 1. í•©ê³„ ê³„ì‚°
            newData.forEach(item => {
                if (item.isEditable) {
                    const dangjwaValue = parseFloat((item.ë‹¹ì¢Œ || `0${UNIT}`).replace(UNIT, '') || '0');
                    const botongValue = parseFloat((item.ë³´í†µ || `0${UNIT}`).replace(UNIT, '') || '0');
                    totalDangjwa += isNaN(dangjwaValue) ? 0 : dangjwaValue;
                    totalBotong += isNaN(botongValue) ? 0 : botongValue;
                }
            });
            
            // 2. 'í•©ê³„' í–‰ ì—…ë°ì´íŠ¸
            const totalBankIndex = newData.findIndex(item => item.name === 'í•©ê³„');
            if (totalBankIndex !== -1) {
                newData[totalBankIndex]['ë‹¹ì¢Œ'] = `${totalDangjwa}${UNIT}`;
                newData[totalBankIndex]['ë³´í†µ'] = `${totalBotong}${UNIT}`;
                newData[totalBankIndex]['í•©ê³„'] = `${totalDangjwa + totalBotong}${UNIT}`;
            }
            return newData;
        }


        /**
         * ì€í–‰ í•­ëª©ì˜ íŠ¹ì • í•„ë“œ ê°’ì„ ì—…ë°ì´íŠ¸í•˜ê³  Firestoreì— ì €ì¥í•©ë‹ˆë‹¤ (Transaction ì‚¬ìš©).
         */
        async function updateBankItemField(indexToUpdate, fieldName, value) {
            if (!isAuthReady || !reportRef) return;
            if (isSaving) { setSaveStatus("ì €ì¥ ì¤‘... ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.", 'text-yellow-600'); return; }

            isSaving = true;
            setSaveStatus("ì €ì¥ ì¤‘...", 'text-yellow-600');
            try {
                await runTransaction(db, async (transaction) => {
                    const docSnapshot = await transaction.get(reportRef);
                    if (!docSnapshot.exists()) throw new Error("ë³´ê³ ì„œ ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                    
                    const currentData = docSnapshot.data().contentFundPrev?.bankData || INITIAL_BANK_DATA_ARRAY;
                    const newData = JSON.parse(JSON.stringify(currentData));

                    if (newData[indexToUpdate]) {
                        newData[indexToUpdate][fieldName] = value;
                    } else {
                        throw new Error("ì˜ëª»ëœ ì€í–‰ í•­ëª© ì¸ë±ìŠ¤ì…ë‹ˆë‹¤.");
                    }

                    const finalData = recalculateTotals(newData);

                    transaction.update(reportRef, {
                        'contentFundPrev.bankData': finalData
                    });
                });
                setSaveStatus("ì €ì¥ ì™„ë£Œ!", 'text-green-600');
            } catch (e) {
                console.error("Transaction failed during bank item update:", e);
                setSaveStatus(`ì €ì¥ ì‹¤íŒ¨: ${e.message}`, 'text-red-600');
            } finally {
                isSaving = false;
            }
        }

        /**
         * ì€í–‰ ì”ì•¡ í…Œì´ë¸”ì— ìƒˆ í•­ëª©ì„ ì¶”ê°€í•©ë‹ˆë‹¤ (Transaction ì‚¬ìš©).
         */
        async function addBankItem() {
            if (!isAuthReady || !reportRef) return;
            if (isSaving) { setSaveStatus("ì €ì¥ ì¤‘... ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.", 'text-yellow-600'); return; }

            isSaving = true;
            setSaveStatus("í•­ëª© ì¶”ê°€ ë° ì €ì¥ ì¤‘...", 'text-yellow-600');
            try {
                await runTransaction(db, async (transaction) => {
                    const docSnapshot = await transaction.get(reportRef);
                    if (!docSnapshot.exists()) throw new Error("ë³´ê³ ì„œ ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                    
                    const currentData = docSnapshot.data().contentFundPrev?.bankData || INITIAL_BANK_DATA_ARRAY;
                    
                    const newName = `ì‹ ê·œì€í–‰${currentData.filter(item => item.isEditable).length + 1}`;
                    const newItem = { name: newName, ë‹¹ì¢Œ: `0${UNIT}`, ë³´í†µ: `0${UNIT}`, í•©ê³„: `0${UNIT}`, isEditable: true };
                    
                    // í•©ê³„ í–‰ ì•ì— ìƒˆ í•­ëª© ì‚½ì…
                    const totalIndex = currentData.findIndex(item => item.name === 'í•©ê³„');
                    
                    const newData = [...currentData];
                    if (totalIndex !== -1) {
                        newData.splice(totalIndex, 0, newItem);
                    } else {
                        newData.push(newItem);
                    }

                    const finalData = recalculateTotals(newData);

                    transaction.update(reportRef, {
                        'contentFundPrev.bankData': finalData
                    });
                });
                setSaveStatus("ì€í–‰ í•­ëª© ì¶”ê°€ ì™„ë£Œ!", 'text-green-600');
            } catch (e) {
                console.error("Transaction failed during bank item addition:", e);
                setSaveStatus(`í•­ëª© ì¶”ê°€ ì‹¤íŒ¨: ${e.message}`, 'text-red-600');
            } finally {
                isSaving = false;
            }
        }

        /**
         * ì€í–‰ ì”ì•¡ í…Œì´ë¸”ì—ì„œ í•­ëª©ì„ ì‚­ì œí•©ë‹ˆë‹¤ (Transaction ì‚¬ìš© - ì‚­ì œ ì˜¤ë¥˜ ìˆ˜ì •ì˜ í•µì‹¬).
         * @param {number} indexToDelete - ì‚­ì œí•  í•­ëª©ì˜ ë°°ì—´ ì¸ë±ìŠ¤
         */
        async function deleteBankItem(indexToDelete) {
            if (!isAuthReady || !reportRef) return;
            if (isSaving) { setSaveStatus("ì €ì¥ ì¤‘... ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.", 'text-yellow-600'); return; }

            isSaving = true;
            setSaveStatus("ì‚­ì œ ë° ì €ì¥ ì¤‘...", 'text-yellow-600');

            try {
                await runTransaction(db, async (transaction) => {
                    const docSnapshot = await transaction.get(reportRef);
                    if (!docSnapshot.exists()) {
                        throw new Error("ë³´ê³ ì„œ ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                    }

                    // ìµœì‹  ë°ì´í„° ì½ê¸°
                    const currentData = docSnapshot.data().contentFundPrev?.bankData || INITIAL_BANK_DATA_ARRAY;

                    // 1. ì‚­ì œ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
                    if (currentData[indexToDelete] && currentData[indexToDelete].isEditable === false) {
                         throw new Error("ê³ ì •ëœ í•©ê³„ í•­ëª©ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    }

                    // 2. í•­ëª© ì‚­ì œ
                    const newData = currentData.filter((_, index) => index !== indexToDelete);
                    
                    // 3. í•©ê³„ ì¬ê³„ì‚°
                    const finalData = recalculateTotals(newData);

                    // 4. Firestoreì— íŠ¸ëœì­ì…˜ ì—…ë°ì´íŠ¸
                    transaction.update(reportRef, {
                        'contentFundPrev.bankData': finalData
                    });
                });

                setSaveStatus("ì€í–‰ í•­ëª© ì‚­ì œ ì™„ë£Œ!", 'text-green-600');
            } catch (e) {
                console.error("Transaction failed during bank item deletion:", e);
                if (e.message.includes("ê³ ì •ëœ í•©ê³„ í•­ëª©ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤")) {
                    setSaveStatus("ê³ ì •ëœ í•©ê³„ í•­ëª©ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", 'text-red-600');
                } else {
                    setSaveStatus(`ì‚­ì œ ì‹¤íŒ¨: ${e.message}`, 'text-red-600');
                }
            } finally {
                isSaving = false;
            }
        }


        // --- 6. UI ë Œë”ë§ ë° ì´ë²¤íŠ¸ í•¸ë“¤ë§ ---

        /**
         * Firestore ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ UIë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤.
         * @param {object} data - Firestore ë¬¸ì„œ ë°ì´í„°
         */
        function renderReport(data) {
            // 1. ë‚ ì§œ ì •ë³´ ì—…ë°ì´íŠ¸
            reportDateDisplay.textContent = `ë³´ê³ ì¼ì: ${data.dateReported}`;
            prevPeriodDisplay.textContent = data.datePeriodPrev;
            currPeriodDisplay.textContent = data.datePeriodCurr;

            // 2. ìê¸ˆ í˜„í™© í‘œ ë Œë”ë§ (ì „ì£¼ì‚¬í•­)
            renderBankTable(data.contentFundPrev.bankData || INITIAL_BANK_DATA_ARRAY);

            // 3. ì£¼ìš” ì—…ë¬´ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
            renderList(fundPrevList, data.contentFundPrev.list || [], 'contentFundPrev', 'list');
            renderList(fundCurrList, data.contentFundCurr.list || [], 'contentFundCurr', 'list');
            renderList(taxPrevList, data.contentTaxPrev.list || [], 'contentTaxPrev', 'list');
            renderList(taxCurrList, data.contentTaxCurr.list || [], 'contentTaxCurr', 'list');
        }

        /**
         * ìê¸ˆ í˜„í™© í‘œë¥¼ ë Œë”ë§í•˜ê³  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
         * (ì´ í•¨ìˆ˜ì—ì„œ deleteBankItem í˜¸ì¶œ ë°©ì‹ ë³€ê²½)
         * @param {Array<object>} bankDataArray - ì€í–‰ë³„ ì”ì•¡ ë°ì´í„° ë°°ì—´
         */
        function renderBankTable(bankDataArray) {
            bankRowsContainer.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”
            
            const addBankContainer = fundBalanceTableContainer.querySelector('#add-bank-item-container');
            addBankContainer.innerHTML = '';
            
            // 1. ì€í–‰ ë°ì´í„° í–‰ ë Œë”ë§ (ë°°ì—´ ì „ì²´ ìˆœíšŒ)
            bankDataArray.forEach((item, index) => {
                const isEditable = item.isEditable !== false;
                
                const row = document.createElement('tr');
                row.className = isEditable 
                    ? 'border-t hover:bg-yellow-50 group' 
                    : 'border-t-2 border-indigo-300 font-bold bg-indigo-50 hover:bg-indigo-100';
                
                let rowContent = '';
                
                // êµ¬ë¶„ (ì€í–‰ ì´ë¦„) ì…€
                const nameCell = document.createElement('td');
                nameCell.className = 'p-2 font-medium relative';
                
                if (isEditable) {
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'editable-content inline-block w-full text-left bg-transparent hover:bg-white';
                    nameSpan.setAttribute('contenteditable', 'true');
                    nameSpan.textContent = item.name;

                    // ì´ë¦„ ì €ì¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (updateBankItemField í˜¸ì¶œ ë°©ì‹ ë³€ê²½)
                    nameSpan.addEventListener('blur', (e) => {
                        const newName = e.target.textContent.trim();
                        if (newName && newName !== item.name) {
                            updateBankItemField(index, 'name', newName); // currentData ì¸ì ì œê±°
                        } else {
                            e.target.textContent = item.name; // ì›ë³µ
                        }
                    });
                    nameCell.appendChild(nameSpan);
                } else {
                    nameCell.textContent = item.name; // í•©ê³„ ê³ ì •
                }
                rowContent += nameCell.outerHTML;


                // ë‹¹ì¢Œ, ë³´í†µ, í•©ê³„ ì…€ ë Œë”ë§
                ['ë‹¹ì¢Œ', 'ë³´í†µ', 'í•©ê³„'].forEach(field => {
                    const cell = document.createElement('td');
                    cell.className = 'p-2 text-right';
                    
                    if (isEditable && field !== 'í•©ê³„') { // í•©ê³„ í•„ë“œëŠ” ìë™ìœ¼ë¡œ ê³„ì‚°ë˜ë¯€ë¡œ í¸ì§‘ ë¶ˆê°€ëŠ¥
                        const editableSpan = document.createElement('span');
                        editableSpan.className = 'editable-content inline-block w-full text-right bg-transparent hover:bg-white';
                        editableSpan.setAttribute('contenteditable', 'true');
                        editableSpan.textContent = item[field];
                        
                        // ê°’ ì €ì¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (updateBankItemField í˜¸ì¶œ ë°©ì‹ ë³€ê²½)
                        editableSpan.addEventListener('blur', (e) => {
                            let newValue = e.target.textContent.trim() || '0';
                            if (!newValue.endsWith(UNIT) && newValue !== '0') {
                                newValue += UNIT;
                            } else if (newValue === '0') {
                                newValue = `0${UNIT}`;
                            }

                            if (newValue !== item[field]) {
                                updateBankItemField(index, field, newValue); // currentData ì¸ì ì œê±°
                            } else {
                                e.target.textContent = item[field]; // ì›ë³µ
                            }
                        });
                        cell.appendChild(editableSpan);
                    } else {
                         // í•©ê³„ í–‰ ë° í•©ê³„ í•„ë“œëŠ” í¸ì§‘ ë¶ˆê°€ëŠ¥
                        cell.textContent = item[field];
                    }
                    rowContent += cell.outerHTML;
                });
                
                // ì‚­ì œ/ì•¡ì…˜ ë²„íŠ¼ ì…€
                const actionCell = document.createElement('td');
                actionCell.className = 'p-1 text-center w-16';

                if (isEditable) {
                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'delete-bank-btn action-button bg-red-100 text-red-600 hover:bg-red-200 transition duration-150 opacity-0 group-hover:opacity-100';
                    deleteButton.textContent = 'ì‚­ì œ';
                    // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (deleteBankItem í˜¸ì¶œ ë°©ì‹ ë³€ê²½)
                    deleteButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteBankItem(index); // indexë§Œ ì „ë‹¬
                    });
                    actionCell.appendChild(deleteButton);
                } else {
                    actionCell.classList.add('text-xs', 'text-gray-500');
                }
                rowContent += actionCell.outerHTML;

                row.innerHTML = rowContent;
                bankRowsContainer.appendChild(row);
            });
            
            // 2. í•­ëª© ì¶”ê°€ ë²„íŠ¼ ì¶”ê°€
            const addButton = document.createElement('button'); 
            addButton.className = 'action-button bg-indigo-100 text-indigo-600 hover:bg-indigo-200 mt-4 w-full';
            addButton.textContent = '+ êµ¬ë¶„ í•­ëª© ì¶”ê°€';
            // í•­ëª© ì¶”ê°€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (addBankItem í˜¸ì¶œ ë°©ì‹ ë³€ê²½)
            addButton.addEventListener('click', () => {
                addBankItem(); // ì¸ì ì œê±°
            });
            addBankContainer.appendChild(addButton); 
        }

        /**
         * ì—…ë¬´ ë¦¬ìŠ¤íŠ¸ë¥¼ ë Œë”ë§í•˜ê³  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
         */
        function renderList(container, data, category, subField) {
            container.innerHTML = ''; 

            data.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex items-start mb-2 group';
                itemDiv.innerHTML = `
                    <span class="mr-2 pt-1 text-gray-400">â€¢</span>
                    <span class="editable-content flex-grow" contenteditable="true" data-index="${index}"></span>
                    <button class="delete-item-btn action-button bg-red-100 text-red-600 hover:bg-red-200 ml-2 opacity-0 group-hover:opacity-100" data-index="${index}">ì‚­ì œ</button>
                `;
                
                const editableSpan = itemDiv.querySelector('.editable-content');
                editableSpan.textContent = item;

                editableSpan.addEventListener('blur', (e) => {
                    const newText = e.target.textContent.trim();
                    const itemIndex = parseInt(e.target.dataset.index);
                    if (newText !== data[itemIndex]) {
                        const newData = [...data];
                        newData[itemIndex] = newText;
                        updateField(`${category}.${subField}`, newData);
                    }
                });
                
                itemDiv.querySelector('.delete-item-btn').addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    deleteItem(category, subField, index, data);
                });

                container.appendChild(itemDiv);
            });

            const addButton = document.createElement('button');
            addButton.className = 'action-button bg-indigo-100 text-indigo-600 hover:bg-indigo-200 mt-4 w-full';
            addButton.textContent = '+ í•­ëª© ì¶”ê°€';
            addButton.addEventListener('click', () => {
                addItem(category, subField, data);
            });
            container.appendChild(addButton);
        }

        /**
         * Firestore ë°°ì—´ì— ìƒˆ í•­ëª©ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
         */
        async function addItem(category, subField, currentData) {
            const newItem = "ìƒˆ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”...";
            const newData = [...currentData, newItem];
            await updateField(`${category}.${subField}`, newData);
        }

        /**
         * Firestore ë°°ì—´ì—ì„œ í•­ëª©ì„ ì‚­ì œí•©ë‹ˆë‹¤.
         */
        async function deleteItem(category, subField, indexToDelete, currentData) {
            try {
                 const newData = currentData.filter((_, index) => index !== indexToDelete);
                 await updateField(`${category}.${subField}`, newData);
                 setSaveStatus("í•­ëª© ì‚­ì œ ì™„ë£Œ", 'text-green-600');
            } catch (error) {
                console.error("Deletion failed:", error);
                setSaveStatus("ì‚­ì œ ì‹¤íŒ¨", 'text-red-600');
            }
        }

        /**
         * ê°•ì œ ì €ì¥ ë²„íŠ¼ ë¡œì§: í˜„ì¬ í¬ì»¤ìŠ¤ëœ ìš”ì†Œë¥¼ blur ì‹œì¼œ ìë™ ì €ì¥ ì´ë²¤íŠ¸ë¥¼ ê°•ì œë¡œ ë°œìƒì‹œí‚µë‹ˆë‹¤.
         */
        function manualSave() {
            const focusedElement = document.activeElement;
            if (focusedElement && focusedElement.classList.contains('editable-content')) {
                focusedElement.blur();
            } else {
                setSaveStatus("ì €ì¥ ì™„ë£Œ!", 'text-green-600');
            }
        }


        // --- 7. ì´ˆê¸° ì‹¤í–‰ ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ---
        window.onload = () => {
            if (!firebaseConfig) {
                const { reportDateFormatted, prevPeriod, currPeriod } = getReportDates();
                reportDateDisplay.textContent = `ë³´ê³ ì¼ì: ${reportDateFormatted}`;
                prevPeriodDisplay.textContent = prevPeriod;
                currPeriodDisplay.textContent = currPeriod;
            }
            
            saveButton.addEventListener('click', manualSave);
            
            printButton.addEventListener('click', () => {
                window.print();
            });
        };

    </script>
</body>
</html>
