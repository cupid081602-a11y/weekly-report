<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>주간 업무보고 (Firestore 협업)</title>
    <!-- Tailwind CSS CDN 로드 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter 폰트 사용 설정 -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        /* 내용 편집 필드의 기본 스타일 */
        .editable-content {
            min-height: 24px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.15s ease-in-out;
            cursor: text;
        }
        .editable-content:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(66, 153, 225, 0.5); /* blue-500 shadow */
            background-color: #fff;
        }
        .editable-container {
            border: 1px solid #e5e7eb; /* gray-200 */
            border-radius: 8px;
            padding: 1rem;
            min-height: 200px;
        }
        /* 추가적인 인쇄 및 UI 스타일 */
        @media print {
            body { background-color: #fff; }
            .header-info, .editable-container, .editable-content { border: 1px solid #000 !important; }
            .print-hidden { display: none !important; }
            /* 편집 가능한 항목에 회색 배경이 들어가지 않도록 */
            .editable-content:focus, .editable-content { background-color: transparent !important; box-shadow: none !important; }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    
    <!-- 1. 헤더 및 컨트롤 영역 -->
    <header class="mb-6 print-hidden flex justify-between items-center bg-white p-4 rounded-xl shadow-lg">
        <div class="flex items-center space-x-4">
            <h1 class="text-2xl font-bold text-gray-800">주간 업무 보고서</h1>
            <p id="report-date-display" class="text-sm font-medium text-gray-500"></p>
        </div>
        <div class="flex items-center space-x-3">
            <span id="save-status" class="text-sm font-medium transition-opacity duration-300 text-gray-500">대기 중...</span>
            <button id="save-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150">
                수동 저장
            </button>
            <button id="print-button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150">
                인쇄
            </button>
        </div>
    </header>

    <!-- 2. 사용자 정보 및 안내 -->
    <div class="print-hidden mb-6 p-4 border border-blue-400 bg-blue-50 rounded-lg text-blue-800 text-sm shadow-md">
        <p class="font-semibold mb-1">🔥 협업 기능 활성화됨</p>
        <p>
            현재 사용자 ID: <span id="user-id" class="font-mono text-xs bg-blue-200 px-1 rounded">인증 중...</span>
            <span class="ml-4"> (모든 변경 사항은 자동으로 저장됩니다.)</span>
        </p>
    </div>

    <!-- 3. 보고서 본문 -->
    <div class="report-container bg-white p-6 md:p-10 rounded-xl shadow-2xl">
        <h2 class="text-center text-3xl font-extrabold text-gray-900 mb-8 pb-2 border-b-4 border-gray-900">
            재무부문 주간 업무 보고
        </h2>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- 왼쪽 섹션: 지난 주 (전주) -->
            <section class="border-r lg:pr-8">
                <h3 class="text-xl font-bold text-gray-700 mb-4 pb-1 border-b-2 border-gray-300">
                    전주 사항 (<span id="prev-period-display" class="font-normal">09/22 ~ 09/26</span>)
                </h3>

                <!-- 자금 현황 테이블 (더미 데이터) -->
                <div class="mb-6">
                    <p class="font-semibold text-lg mb-2">자금 현황 (09/26 기준)</p>
                    <table class="w-full text-sm border-collapse">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border p-2 font-medium"></th>
                                <th class="border p-2 font-medium">당좌</th>
                                <th class="border p-2 font-medium">보통</th>
                                <th class="border p-2 font-medium">합계</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="border p-2 font-semibold">자금 현황</td>
                                <td class="border p-2 editable-content" contenteditable="true" data-field="finance.funds.demand">0억</td>
                                <td class="border p-2 editable-content" contenteditable="true" data-field="finance.funds.checking">백만원</td>
                                <td class="border p-2 editable-content" contenteditable="true" data-field="finance.funds.total">백만원</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 업무/회계 항목 -->
                <div class="mb-6">
                    <p class="font-semibold text-lg mb-2 border-b border-gray-200">주요 업무</p>
                    <div id="weekly-tasks-prev" class="space-y-2 editable-container">
                        <!-- 항목이 여기에 로드됩니다 -->
                    </div>
                    <button class="add-item-button mt-2 text-sm text-indigo-600 hover:text-indigo-800 transition duration-150 print-hidden" data-category="weeklyTasksPrev" data-subfield="items">
                        + 항목 추가
                    </button>
                </div>
            </section>

            <!-- 오른쪽 섹션: 금주 계획 (금주) -->
            <section>
                <h3 class="text-xl font-bold text-gray-700 mb-4 pb-1 border-b-2 border-gray-300">
                    금주/다음 주 계획 (<span id="curr-period-display" class="font-normal">09/29 ~ 10/02</span>)
                </h3>

                <!-- 금주 계획 항목 -->
                <div class="mb-6">
                    <p class="font-semibold text-lg mb-2 border-b border-gray-200">주간 계획</p>
                    <div id="weekly-plan-curr" class="space-y-2 editable-container">
                        <!-- 항목이 여기에 로드됩니다 -->
                    </div>
                    <button class="add-item-button mt-2 text-sm text-indigo-600 hover:text-indigo-800 transition duration-150 print-hidden" data-category="weeklyPlanCurr" data-subfield="items">
                        + 항목 추가
                    </button>
                </div>

                <!-- 비고/특이사항 -->
                <div class="mb-6">
                    <p class="font-semibold text-lg mb-2 border-b border-gray-200">비고 및 특이사항</p>
                    <div class="space-y-2 editable-container">
                        <div class="editable-content w-full" contenteditable="true" data-field="notes.main">
                            금주 특이사항이나 협조 요청 사항을 기재하세요. (클릭하여 편집)
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Firebase SDK 로드 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, collection, getDocs, query, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-lite.js";
        
        // Firestore 디버깅 활성화
        setLogLevel('debug'); 

        // --- 1. 전역 변수 설정 및 Firebase 초기화 ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId = null;
        let isAuthReady = false;
        let reportData = {};
        const REPORT_COLLECTION = 'weeklyReports';
        const REPORT_DOC_ID = 'currentReport';

        const saveStatus = document.getElementById('save-status');
        const userIdDisplay = document.getElementById('user-id');
        const saveButton = document.getElementById('save-button');
        const printButton = document.getElementById('print-button');
        const reportDateDisplay = document.getElementById('report-date-display');
        const prevPeriodDisplay = document.getElementById('prev-period-display');
        const currPeriodDisplay = document.getElementById('curr-period-display');

        /**
         * @param {string} msg
         * @param {string} colorClass
         */
        function setSaveStatus(msg, colorClass = 'text-gray-500') {
            saveStatus.textContent = msg;
            saveStatus.className = `text-sm font-medium transition-opacity duration-300 ${colorClass}`;
            setTimeout(() => {
                saveStatus.textContent = "대기 중...";
                saveStatus.className = 'text-sm font-medium transition-opacity duration-300 text-gray-500';
            }, 3000);
        }

        // 날짜 계산 함수
        function getReportDates() {
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const day = today.getDate().toString().padStart(2, '0');
            const reportDateFormatted = `${year}.${month}.${day}`;
            
            // 임시로 하드코딩된 기간 (실제 앱에서는 유동적으로 계산해야 함)
            const prevPeriod = "09/22 ~ 09/26";
            const currPeriod = "09/29 ~ 10/02";
            
            return { reportDateFormatted, prevPeriod, currPeriod };
        }

        if (firebaseConfig) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (e) {
                console.error("Firebase Initialization Error:", e);
                setSaveStatus("Firebase 연결 실패", 'text-red-600');
            }
        }

        // --- 2. 인증 및 사용자 ID 설정 ---
        async function authenticate() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                setSaveStatus("인증 실패", 'text-red-600');
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                userIdDisplay.textContent = userId;
                isAuthReady = true;
                if (db) {
                    startRealtimeListener();
                }
            } else {
                // 익명 로그인 시에도 uid가 부여되므로, 이 블록은 거의 실행되지 않음
                userId = crypto.randomUUID();
                userIdDisplay.textContent = userId + " (익명)";
                isAuthReady = true;
            }
        });

        // Firebase 설정이 있을 때만 인증 시도
        if (firebaseConfig) {
            authenticate();
        }

        // --- 3. Firestore 실시간 리스너 ---
        function startRealtimeListener() {
            if (!isAuthReady || !db) return;
            
            // 공용 데이터 경로: /artifacts/{appId}/public/data/weeklyReports/currentReport
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', REPORT_COLLECTION, REPORT_DOC_ID);
            
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    reportData = docSnap.data();
                } else {
                    reportData = {};
                    console.log("No such document! Initializing...");
                }
                renderReport(reportData);
                setSaveStatus("데이터 로드 완료", 'text-green-600');
            }, (error) => {
                console.error("Firestore listen failed:", error);
                setSaveStatus("데이터 로드 오류", 'text-red-600');
            });
        }

        // --- 4. 데이터 렌더링 및 UI 업데이트 ---
        /**
         * @param {object} data
         */
        function renderReport(data) {
            const { reportDateFormatted, prevPeriod, currPeriod } = getReportDates();
            reportDateDisplay.textContent = `보고일자: ${reportDateFormatted}`;
            prevPeriodDisplay.textContent = prevPeriod;
            currPeriodDisplay.textContent = currPeriod;

            // 1. 일반 편집 필드 렌더링
            document.querySelectorAll('.editable-content').forEach(el => {
                const field = el.dataset.field;
                if (field) {
                    const [category, subField, index] = field.split('.');
                    let content = data;
                    if (category && content[category]) content = content[category];
                    if (subField && content[subField]) content = content[subField];
                    
                    if (content !== null && content !== undefined) {
                        el.textContent = content.toString();
                    } else if (!el.textContent.trim()) {
                         // 데이터가 없을 때만 placeholder 유지
                    }
                }
            });

            // 2. 리스트 항목 렌더링
            renderList('weeklyTasksPrev', data.weeklyTasksPrev?.items || []);
            renderList('weeklyPlanCurr', data.weeklyPlanCurr?.items || []);

            // 이벤트 리스너 다시 연결 (렌더링 후)
            attachEditableEventListeners();
        }

        /**
         * @param {string} containerId
         * @param {Array<string>} items
         */
        function renderList(containerId, items) {
            const container = document.getElementById(containerId);
            if (!container) return;

            container.innerHTML = '';
            
            items.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex items-start group hover:bg-gray-50 p-1 rounded';
                itemDiv.innerHTML = `
                    <span class="mr-2 text-gray-500">•</span>
                    <div class="editable-content flex-grow" contenteditable="true" data-field="${containerId}.items.${index}">${item}</div>
                    <button class="delete-item-button ml-2 text-red-500 hover:text-red-700 opacity-0 group-hover:opacity-100 transition duration-150 print-hidden" 
                            data-category="${containerId}" 
                            data-subfield="items" 
                            data-index="${index}">
                        &times;
                    </button>
                `;
                container.appendChild(itemDiv);
            });
        }


        // --- 5. 이벤트 처리 및 데이터 저장 로직 ---
        function attachEditableEventListeners() {
            document.querySelectorAll('.editable-content').forEach(el => {
                // 기존 리스너 제거 방지 (onSnapshot에서 매번 호출되므로)

                // blur 이벤트 리스너 추가 (자동 저장)
                el.onblur = (event) => {
                    if (!isAuthReady || !db) return;
                    const field = event.target.dataset.field;
                    const newValue = event.target.textContent.trim();
                    if (field && newValue !== getDeepValue(reportData, field)) {
                        updateField(field, newValue);
                    }
                };
            });

            document.querySelectorAll('.add-item-button').forEach(button => {
                button.onclick = (event) => {
                    if (!isAuthReady || !db) return;
                    const category = event.target.dataset.category;
                    const subField = event.target.dataset.subfield;
                    addItemToField(category, subField, "새 항목을 입력하세요 (클릭하여 편집)");
                };
            });

            document.querySelectorAll('.delete-item-button').forEach(button => {
                button.onclick = (event) => {
                    if (!isAuthReady || !db) return;
                    const category = event.target.dataset.category;
                    const subField = event.target.dataset.subfield;
                    const index = parseInt(event.target.dataset.index, 10);
                    deleteItemFromField(category, subField, index);
                };
            });
        }

        /**
         * @param {object} obj
         * @param {string} path
         */
        function getDeepValue(obj, path) {
            try {
                const parts = path.split('.');
                let current = obj;
                for (const part of parts) {
                    // 배열 인덱스인 경우 처리
                    if (!isNaN(parseInt(part, 10)) && Array.isArray(current)) {
                        current = current[parseInt(part, 10)];
                    } else if (current && typeof current === 'object' && current[part] !== undefined) {
                        current = current[part];
                    } else {
                        return undefined;
                    }
                }
                return current;
            } catch (e) {
                return undefined;
            }
        }


        // --- 6. Firestore 데이터 조작 함수 ---
        const docRef = () => doc(db, 'artifacts', appId, 'public', 'data', REPORT_COLLECTION, REPORT_DOC_ID);

        /**
         * @param {string} path
         * @param {any} value
         */
        async function updateField(path, value) {
            if (!db || !userId) return;
            
            try {
                const updateObject = {};
                
                // Firestore에서 점(.) 표기법으로 중첩 필드 업데이트를 지원하지만,
                // 리스트 항목 업데이트는 따로 처리 (배열 인덱스를 직접 업데이트 불가)
                const parts = path.split('.');
                const index = parseInt(parts[parts.length - 1], 10);
                
                if (!isNaN(index)) { // 리스트 항목 업데이트
                     const listPath = parts.slice(0, parts.length - 1).join('.');
                     const list = getDeepValue(reportData, listPath) || [];
                     if (index >= 0 && index < list.length) {
                         list[index] = value;
                         updateObject[listPath] = list;
                         
                     } else {
                        console.warn("Invalid index for update:", path, index);
                        return;
                     }
                } else { // 일반 필드 업데이트
                    updateObject[path] = value;
                }

                await setDoc(docRef(), updateObject, { merge: true });
                setSaveStatus("자동 저장 완료", 'text-green-600');

            } catch (error) {
                console.error("Firestore update failed:", error);
                setSaveStatus("저장 실패", 'text-red-600');
            }
        }

        /**
         * @param {string} category
         * @param {string} subField
         * @param {string} newItem
         */
        async function addItemToField(category, subField, newItem) {
            if (!db || !userId) return;
            const fullPath = `${category}.${subField}`;
            
            try {
                 // reportData를 사용하여 현재 배열을 가져옴
                 const currentList = getDeepValue(reportData, fullPath) || [];
                 const list = Array.isArray(currentList) ? currentList : [];

                 const newArray = [...list, newItem];
                 
                 const updateObject = {};
                 updateObject[fullPath] = newArray;
                 
                 await setDoc(docRef(), updateObject, { merge: true });
                 setSaveStatus("항목 추가 완료", 'text-green-600');

            } catch (error) {
                console.error("Addition failed:", error);
                setSaveStatus("추가 실패", 'text-red-600');
            }
        }

        /**
         * @param {string} category
         * @param {string} subField
         * @param {number} indexToDelete
         */
        async function deleteItemFromField(category, subField, indexToDelete) {
            if (!db || !userId) return;
            const fullPath = `${category}.${subField}`;
            
            try {
                 const currentList = getDeepValue(reportData, fullPath) || [];
                 const list = Array.isArray(currentList) ? currentList : [];

                 const newData = list.filter((_, index) => index !== indexToDelete);
                 
                 const updateObject = {};
                 updateObject[fullPath] = newData;

                 await setDoc(docRef(), updateObject, { merge: true });
                 setSaveStatus("항목 삭제 완료", 'text-green-600');
            } catch (error) {
                console.error("Deletion failed:", error);
                setSaveStatus("삭제 실패", 'text-red-600');
            }
        }

        /**
         * 강제 저장 버튼 로직: 현재 포커스된 요소를 blur 시켜 자동 저장 이벤트를 강제로 발생시킵니다.
         */
        function manualSave() {
            const focusedElement = document.activeElement;
            if (focusedElement && focusedElement.classList.contains('editable-content')) {
                focusedElement.blur();
            } else {
                setSaveStatus("저장 완료!", 'text-green-600');
            }
        }


        // --- 7. 초기 실행 및 이벤트 리스너 등록 ---\
        window.onload = () => {
            if (!firebaseConfig) {
                const { reportDateFormatted, prevPeriod, currPeriod } = getReportDates();
                reportDateDisplay.textContent = `보고일자: ${reportDateFormatted}`;
                prevPeriodDisplay.textContent = prevPeriod;
                currPeriodDisplay.textContent = currPeriod;
            }
            
            saveButton.addEventListener('click', manualSave);
            
            printButton.addEventListener('click', () => {
                window.print();
            });
        };

    </script>
</body>
</html>
